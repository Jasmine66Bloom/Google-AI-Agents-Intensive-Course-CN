"""
ç¬¬4å¤©Bï¼šä»£ç†è¯„ä¼°

æœ¬ç¬”è®°æœ¬æ¶µç›–ï¼š
- åˆ›å»ºæµ‹è¯•ç”¨ä¾‹ä»¥éªŒè¯ä»£ç†è¡Œä¸º
- ä½¿ç”¨ CLI è¿›è¡Œç³»ç»Ÿæ€§è¯„ä¼°
- ç†è§£è¯„ä¼°æŒ‡æ ‡å’Œæ ‡å‡†
- åˆ†æå’Œä¿®å¤è¯„ä¼°å¤±è´¥
- é«˜çº§ç”¨æˆ·æ¨¡æ‹Ÿæ¦‚å¿µ

ç‰ˆæƒæ‰€æœ‰ 2025 Google LLCã€‚
æ ¹æ® Apache è®¸å¯è¯ 2.0 ç‰ˆæœ¬è·å¾—è®¸å¯
"""

import os
import json
from google.adk.agents import LlmAgent
from google.adk.models.google_llm import Gemini
from google.adk.runners import InMemoryRunner
from google.genai import types

# ============================================================================
# è®¾ç½®å’Œé…ç½®
# ============================================================================

# ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
from dotenv import load_dotenv

load_dotenv()

# éªŒè¯ API å¯†é’¥å·²è®¾ç½®
if not os.getenv("GOOGLE_API_KEY"):
    print("âŒ é”™è¯¯ï¼šåœ¨ç¯å¢ƒå˜é‡ä¸­æœªæ‰¾åˆ° GOOGLE_API_KEY")
    print("   è¯·ç¡®ä¿æ‚¨æœ‰ä¸€ä¸ªè®¾ç½®äº† GOOGLE_API_KEY çš„ .env æ–‡ä»¶")
    exit(1)

print("âœ… ADK ç»„ä»¶å¯¼å…¥æˆåŠŸã€‚")
print("âœ… API å¯†é’¥ä» .env æ–‡ä»¶åŠ è½½")

# ============================================================================
# é…ç½®é‡è¯•é€‰é¡¹
# ============================================================================

retry_config = types.HttpRetryOptions(
    attempts=5,
    exp_base=7,
    initial_delay=1,
    http_status_codes=[429, 500, 503, 504],
)

# ============================================================================
# ç¬¬1èŠ‚ï¼šå®¶åº­è‡ªåŠ¨åŒ–ä»£ç†
# ============================================================================


def set_device_status(location: str, device_id: str, status: str) -> dict:
    """è®¾ç½®æ™ºèƒ½å®¶å±…è®¾å¤‡çš„çŠ¶æ€ã€‚

    å‚æ•°ï¼š
        locationï¼šè®¾å¤‡æ‰€åœ¨çš„æˆ¿é—´ã€‚
        device_idï¼šè®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
        statusï¼šæœŸæœ›çš„çŠ¶æ€ï¼Œ'ON' æˆ– 'OFF'ã€‚

    è¿”å›ï¼š
        ç¡®è®¤æ“ä½œçš„å­—å…¸ã€‚
    """
    print(f"å·¥å…·è°ƒç”¨ï¼šå°† {location} ä¸­çš„ {device_id} è®¾ç½®ä¸º {status}")
    return {
        "success": True,
        "message": f"æˆåŠŸå°† {location} ä¸­çš„ {device_id} è®¾ç½®ä¸º {status.lower()}ã€‚",
    }


def create_home_automation_agent():
    """åˆ›å»ºä¸€ä¸ªå®¶åº­è‡ªåŠ¨åŒ–ä»£ç†"""

    agent = LlmAgent(
        name="home_automation_agent",
        model=Gemini(model="gemini-2.5-flash-lite", retry_options=retry_config),
        instruction="""æ‚¨æ˜¯ä¸€ä¸ªå®¶åº­è‡ªåŠ¨åŒ–åŠ©æ‰‹ã€‚æ‚¨çš„ä»»åŠ¡æ˜¯æ§åˆ¶å®¶ä¸­çš„æ™ºèƒ½è®¾å¤‡ã€‚

        æ‚¨å¯ä»¥ä½¿ç”¨ set_device_status å·¥å…·æ¥ï¼š
        - æ‰“å¼€æˆ–å…³é—­ç‰¹å®šæˆ¿é—´ä¸­çš„è®¾å¤‡
        - location å‚æ•°åº”æŒ‡å®šæˆ¿é—´åç§°ï¼ˆä¾‹å¦‚ï¼Œ'living_room', 'kitchen'ï¼‰
        - device_id å‚æ•°åº”æŒ‡å®šè®¾å¤‡åç§°ï¼ˆä¾‹å¦‚ï¼Œ'main_light', 'floor_lamp'ï¼‰
        - status å‚æ•°åº”ä¸º 'ON' æˆ– 'OFF'

        è¯·å§‹ç»ˆç¡®è®¤æ‚¨æ‰§è¡Œçš„æ“ä½œå¹¶æä¾›æ¸…æ™°çš„çŠ¶æ€æ›´æ–°ã€‚
        """,
        tools=[set_device_status],
    )

    return agent


# ============================================================================
# ç¬¬2èŠ‚ï¼šè¯„ä¼°é…ç½®
# ============================================================================


def create_evaluation_config(output_dir: str = "."):
    """
    åˆ›å»ºå¸¦æœ‰é€šè¿‡/å¤±è´¥é˜ˆå€¼çš„è¯„ä¼°é…ç½®æ–‡ä»¶ã€‚

    å‚æ•°ï¼š
        output_dirï¼šå†™å…¥é…ç½®æ–‡ä»¶çš„ç›®å½•
    """

    eval_config = {
        "criteria": {
            "tool_trajectory_avg_score": 1.0,  # éœ€è¦å®Œç¾çš„å·¥å…·ä½¿ç”¨
            "response_match_score": 0.8,  # 80% æ–‡æœ¬ç›¸ä¼¼åº¦é˜ˆå€¼
        }
    }

    config_path = os.path.join(output_dir, "test_config.json")
    with open(config_path, "w") as f:
        json.dump(eval_config, f, indent=2)

    return config_path


# ============================================================================
# ç¬¬3èŠ‚ï¼šæµ‹è¯•ç”¨ä¾‹åˆ›å»º
# ============================================================================


def create_test_cases(output_dir: str = "."):
    """
    åˆ›å»ºè¯„ä¼°æµ‹è¯•ç”¨ä¾‹ã€‚

    å‚æ•°ï¼š
        output_dirï¼šå†™å…¥æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶çš„ç›®å½•
    """

    # å®šä¹‰æµ‹è¯•ç”¨ä¾‹
    test_cases = [
        {
            "user_input": "è¯·æ‰“å¼€å®¢å…çš„è½åœ°ç¯",
            "expected_tool_calls": [
                {
                    "name": "set_device_status",
                    "parameters": {
                        "location": "living_room",
                        "device_id": "floor_lamp",
                        "status": "ON"
                    }
                }
            ],
            "expected_response": "å·²å°†å®¢å…çš„è½åœ°ç¯è®¾ç½®ä¸ºå¼€ã€‚",
        },
        {
            "user_input": "æ‰“å¼€å¨æˆ¿çš„ä¸»ç¯ã€‚",
            "expected_tool_calls": [
                {
                    "name": "set_device_status",
                    "parameters": {
                        "location": "kitchen",
                        "device_id": "main_light",
                        "status": "ON"
                    }
                }
            ],
            "expected_response": "å·²å°†å¨æˆ¿çš„ä¸»ç¯è®¾ç½®ä¸ºå¼€ã€‚",
        },
        {
            "user_input": "å…³é—­å§å®¤çš„å°ç¯",
            "expected_tool_calls": [
                {
                    "name": "set_device_status",
                    "parameters": {
                        "location": "bedroom",
                        "device_id": "desk_lamp",
                        "status": "OFF"
                    }
                }
            ],
            "expected_response": "å·²å°†å§å®¤çš„å°ç¯è®¾ç½®ä¸ºå…³ã€‚",
        }
    ]

    # åˆ›å»ºè¯„ä¼°é›†
    eval_set = {
        "description": "å®¶åº­è‡ªåŠ¨åŒ–ä»£ç†çš„é›†æˆæµ‹è¯•",
        "test_cases": test_cases
    }

    # å†™å…¥æ–‡ä»¶
    eval_path = os.path.join(output_dir, "integration.evalset.json")
    with open(eval_path, "w") as f:
        json.dump(eval_set, f, indent=2)

    return eval_path


# ============================================================================
# ç¬¬4èŠ‚ï¼šè¿è¡Œè¯„ä¼°
# ============================================================================


async def run_evaluation_demo():
    """æ¼”ç¤ºå¦‚ä½•è¿è¡Œè¯„ä¼°"""
    print("\n" + "=" * 80)
    print("æ¼”ç¤ºï¼šè¿è¡Œä»£ç†è¯„ä¼°")
    print("=" * 80)

    # åˆ›å»ºä»£ç†
    agent = create_home_automation_agent()
    runner = InMemoryRunner(agent=agent)

    # åˆ›å»ºé…ç½®å’Œæµ‹è¯•ç”¨ä¾‹
    config_path = create_evaluation_config()
    test_cases_path = create_test_cases()

    print(f"\nâœ… è¯„ä¼°é…ç½®å·²åˆ›å»ºï¼")
    print(f"   ä¿å­˜åˆ°ï¼š{config_path}")

    print(f"\nâœ… è¯„ä¼°æµ‹è¯•ç”¨ä¾‹å·²åˆ›å»º")
    print(f"   ä¿å­˜åˆ°ï¼š{test_cases_path}")

    # è¿è¡Œä¸€ä¸ªç¤ºä¾‹æµ‹è¯•ç”¨ä¾‹
    print("\nğŸš€ è¿è¡Œç¤ºä¾‹æµ‹è¯•ç”¨ä¾‹...")
    test_input = "è¯·æ‰“å¼€å®¢å…çš„è½åœ°ç¯"
    response = await runner.run(test_input)

    print(f"\nğŸ“‹ ç”¨æˆ·è¾“å…¥ï¼š{test_input}")
    print(f"ğŸ¤– ä»£ç†å“åº”ï¼š{response}")

    print("\nğŸ’¡ è¦è¿è¡Œå®Œæ•´çš„è¯„ä¼°ï¼Œè¯·ä½¿ç”¨ï¼š")
    print(f"   adk eval home_automation_agent {test_cases_path} \\")
    print(f"              --config_file_path={config_path} \\")
    print(f"              --print_detailed_results")


# ============================================================================
# ç¬¬5èŠ‚ï¼šè¯„ä¼°æŒ‡æ ‡è§£é‡Š
# ============================================================================


def explain_evaluation_metrics():
    """è§£é‡Šè¯„ä¼°æŒ‡æ ‡"""
    print("\n" + "=" * 80)
    print("è¯„ä¼°æŒ‡æ ‡è§£é‡Š")
    print("=" * 80)

    print("\nğŸ“Š è¯„ä¼°æ ‡å‡†ï¼š")
    print("â€¢ tool_trajectory_avg_scoreï¼šæµ‹é‡æ­£ç¡®çš„å·¥å…·ä½¿ç”¨ï¼ˆ1.0 = å®Œç¾ï¼‰")
    print("  - æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„å·¥å…·")
    print("  - æ£€æŸ¥æ˜¯å¦ä¼ é€’äº†æ­£ç¡®çš„å‚æ•°")
    print("  - æ£€æŸ¥æ˜¯å¦æŒ‰æ­£ç¡®çš„é¡ºåºè°ƒç”¨äº†å·¥å…·")
    print("  - åˆ†æ•° 1.0 è¡¨ç¤ºå®Œç¾çš„å·¥å…·ä½¿ç”¨")

    print("\nâ€¢ response_match_scoreï¼šæµ‹é‡æ–‡æœ¬ç›¸ä¼¼åº¦ï¼ˆ1.0 = å®Œå…¨åŒ¹é…ï¼‰")
    print("  - æ¯”è¾ƒå®é™…å“åº”ä¸é¢„æœŸå“åº”")
    print("  - ä½¿ç”¨è¯­ä¹‰ç›¸ä¼¼åº¦ç®—æ³•")
    print("  - åˆ†æ•° 1.0 è¡¨ç¤ºå®Œå…¨åŒ¹é…")
    print("  - åˆ†æ•° 0.8 è¡¨ç¤º 80% ç›¸ä¼¼åº¦")

    print("\nğŸ¯ é˜ˆå€¼è®¾ç½®ï¼š")
    print("â€¢ tool_trajectory_avg_scoreï¼š1.0")
    print("  - éœ€è¦ç²¾ç¡®çš„å·¥å…·ä½¿ç”¨åŒ¹é…")
    print("  - å¯¹äºå…³é”®æ“ä½œå¾ˆé‡è¦ï¼ˆå®‰å…¨ã€è´¢åŠ¡ï¼‰")

    print("\nâ€¢ response_match_scoreï¼š0.8")
    print("  - éœ€è¦ 80% çš„æ–‡æœ¬ç›¸ä¼¼åº¦")
    print("  - å…è®¸è½»å¾®çš„æªè¾å˜åŒ–")
    print("  - ä¸“æ³¨äºè¯­ä¹‰ç­‰ä»·è€Œéå®Œå…¨åŒ¹é…")


# ============================================================================
# ç¬¬6èŠ‚ï¼šæ•…éšœæ’é™¤
# ============================================================================


def troubleshoot_evaluation_failures():
    """æä¾›è¯„ä¼°å¤±è´¥çš„æ•…éšœæ’é™¤æŒ‡å—"""
    print("\n" + "=" * 80)
    print("è¯„ä¼°æ•…éšœæ’é™¤æŒ‡å—")
    print("=" * 80)

    print("\nğŸ”§ å¸¸è§è¯„ä¼°å¤±è´¥å’Œè§£å†³æ–¹æ¡ˆï¼š")

    print("\n1. å·¥å…·è½¨è¿¹å¾—åˆ†ä½ï¼š")
    print("   ç—‡çŠ¶ï¼štool_trajectory_avg_score < 1.0")
    print("   åŸå› ï¼šä»£ç†ä½¿ç”¨äº†é”™è¯¯çš„å·¥å…·æˆ–å‚æ•°")
    print("   è§£å†³æ–¹æ¡ˆï¼š")
    print("   - æ£€æŸ¥å·¥å…·åç§°æ˜¯å¦æ­£ç¡®")
    print("   - éªŒè¯å‚æ•°åç§°å’Œå€¼")
    print("   - æ”¹è¿›ä»£ç†æŒ‡ä»¤ä¸­çš„å·¥å…·ä½¿ç”¨è¯´æ˜")

    print("\n2. å“åº”åŒ¹é…å¾—åˆ†ä½ï¼š")
    print("   ç—‡çŠ¶ï¼šresponse_match_score < 0.8")
    print("   åŸå› ï¼šä»£ç†å“åº”ä¸é¢„æœŸä¸åŒ¹é…")
    print("   è§£å†³æ–¹æ¡ˆï¼š")
    print("   - æ£€æŸ¥é¢„æœŸå“åº”æ˜¯å¦åˆç†")
    print("   - æ”¹è¿›ä»£ç†æŒ‡ä»¤ä»¥è·å¾—ä¸€è‡´çš„å“åº”")
    print("   - è€ƒè™‘è°ƒæ•´å“åº”åŒ¹é…é˜ˆå€¼")

    print("\n3. ä»£ç†æœªè°ƒç”¨å·¥å…·ï¼š")
    print("   ç—‡çŠ¶ï¼šæ²¡æœ‰å·¥å…·è°ƒç”¨ä½†é¢„æœŸæœ‰")
    print("   åŸå› ï¼šä»£ç†æ²¡æœ‰è¯†åˆ«å‡ºéœ€è¦ä½¿ç”¨å·¥å…·")
    print("   è§£å†³æ–¹æ¡ˆï¼š")
    print("   - æ”¹è¿›ä»£ç†æŒ‡ä»¤ä»¥æ˜ç¡®ä½•æ—¶ä½¿ç”¨å·¥å…·")
    print("   - æä¾›æ›´æ¸…æ™°çš„å·¥å…·æè¿°")
    print("   - åœ¨æŒ‡ä»¤ä¸­æ·»åŠ ç¤ºä¾‹")

    print("\n4. ä»£ç†è°ƒç”¨äº†é”™è¯¯çš„å·¥å…·ï¼š")
    print("   ç—‡çŠ¶ï¼šè°ƒç”¨äº†å·¥å…·ä½†ä¸æ˜¯é¢„æœŸçš„å·¥å…·")
    print("   åŸå› ï¼šä»£ç†è¯¯è§£äº†è¯·æ±‚")
    print("   è§£å†³æ–¹æ¡ˆï¼š")
    print("   - æ”¹è¿›ä»£ç†æŒ‡ä»¤ä»¥æ¾„æ¸…å·¥å…·ç”¨é€”")
    print("   - ä½¿å·¥å…·æè¿°æ›´å…·ä½“")
    print("   - æ·»åŠ æ›´å¤šç¤ºä¾‹")


# ============================================================================
# ä¸»å‡½æ•°
# ============================================================================


async def main():
    """è¿è¡Œæ‰€æœ‰è¯„ä¼°æ¼”ç¤º"""

    print("\n" + "=" * 80)
    print("ç¬¬4å¤©Bï¼šä»£ç†è¯„ä¼°")
    print("=" * 80)

    print("\nğŸ“š æ‚¨å°†å­¦åˆ°ï¼š")
    print("â€¢ åœ¨ ADK Web UI ä¸­äº¤äº’å¼åˆ›å»ºæµ‹è¯•ç”¨ä¾‹")
    print("â€¢ ä½¿ç”¨ CLI è¿è¡Œç³»ç»Ÿæ€§è¯„ä¼°")
    print("â€¢ ç†è§£è¯„ä¼°æŒ‡æ ‡")
    print("â€¢ åˆ†æå’Œä¿®å¤è¯„ä¼°å¤±è´¥")
    print("â€¢ é«˜çº§ç”¨æˆ·æ¨¡æ‹Ÿæ¦‚å¿µ")

    # æ¼”ç¤º1ï¼šè¿è¡Œè¯„ä¼°
    await run_evaluation_demo()

    # æ¼”ç¤º2ï¼šè§£é‡ŠæŒ‡æ ‡
    explain_evaluation_metrics()

    # æ¼”ç¤º3ï¼šæ•…éšœæ’é™¤
    troubleshoot_evaluation_failures()

    print("\n" + "=" * 80)
    print("æ€»ç»“")
    print("=" * 80)
    print("\nğŸ¯ å…³é”®è¦ç‚¹ï¼š")
    print("âœ… è¯„ä¼°æ˜¯ä¸»åŠ¨çš„ï¼ˆå¯è§‚æµ‹æ€§æ˜¯è¢«åŠ¨çš„ï¼‰")
    print("âœ… åŒæ—¶æµ‹è¯•å·¥å…·ä½¿ç”¨å’Œå“åº”è´¨é‡")
    print("âœ… ä½¿ç”¨ ADK Web UI è¿›è¡Œå¼€å‘è¿­ä»£")
    print("âœ… ä½¿ç”¨ CLI è¯„ä¼°è¿›è¡Œç³»ç»Ÿæ€§å›å½’æµ‹è¯•")
    print("âœ… ç”¨æˆ·æ¨¡æ‹Ÿå°†è¦†ç›–èŒƒå›´æ‰©å±•åˆ°é™æ€æµ‹è¯•ä¹‹å¤–")

    print("\nğŸ“Š è¯„ä¼°å·¥ä½œæµç¨‹ï¼š")
    print("1. åˆ›å»ºæµ‹è¯•ç”¨ä¾‹ï¼ˆWeb UI æˆ–åˆæˆï¼‰")
    print("2. å®šä¹‰è¯„ä¼°æ ‡å‡†ï¼ˆé…ç½®æ–‡ä»¶ï¼‰")
    print("3. è¿è¡Œè¯„ä¼°ï¼ˆadk eval CLIï¼‰")
    print("4. åˆ†æç»“æœï¼ˆè¯¦ç»†è¾“å‡ºï¼‰")
    print("5. ä¿®å¤é—®é¢˜å¹¶è¿­ä»£")

    print("\nğŸ“š äº†è§£æ›´å¤šï¼š")
    print("â€¢ ADK è¯„ä¼°ï¼šhttps://google.github.io/adk-docs/evaluate/")
    print("â€¢ è¯„ä¼°æ ‡å‡†ï¼šhttps://google.github.io/adk-docs/evaluate/criteria/")
    print("â€¢ Pytest é›†æˆï¼šhttps://google.github.io/adk-docs/evaluate/#2-pytest-run-tests-programmatically")
    print("â€¢ ç”¨æˆ·æ¨¡æ‹Ÿï¼šhttps://google.github.io/adk-docs/evaluate/user-sim/")

    print("\nğŸš€ ä¸‹ä¸€æ­¥ï¼š")
    print("â€¢ å°†è¯„ä¼°åº”ç”¨äºæ‚¨è‡ªå·±çš„ä»£ç†")
    print("â€¢ æ„å»ºå…¨é¢çš„æµ‹è¯•å¥—ä»¶")
    print("â€¢ é›†æˆåˆ°æ‚¨çš„å¼€å‘å·¥ä½œæµç¨‹ä¸­")
    print("â€¢ æ•¬è¯·æœŸå¾…ç¬¬5å¤©ï¼šç”Ÿäº§éƒ¨ç½²ï¼")


if __name__ == "__main__":
    import asyncio

    asyncio.run(main())
