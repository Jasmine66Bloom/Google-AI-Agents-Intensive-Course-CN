# ç¬¬3å¤© - å†…å­˜ç®¡ç†ä¸ä¸Šä¸‹æ–‡å·¥ç¨‹

æœ¬æ–‡ä»¶å¤¹åŒ…å«åŸºäº Kaggle 5å¤©æ™ºèƒ½ä½“è¯¾ç¨‹ç¬¬3å¤© Jupyter ç¬”è®°æœ¬çš„ Python è„šæœ¬ã€‚

## è„šæœ¬æ¦‚è¿°

### 1. `day_3a_agent_sessions.py`
**å†…å­˜ç®¡ç† ç¬¬1éƒ¨åˆ† - ä¼šè¯**

æ­¤è„šæœ¬æ¼”ç¤ºï¼š
- ä»€ä¹ˆæ˜¯ä¼šè¯ä»¥åŠå¦‚ä½•åœ¨æ™ºèƒ½ä½“ä¸­ä½¿ç”¨å®ƒä»¬
- ä½¿ç”¨ä¼šè¯å’Œäº‹ä»¶æ„å»ºæœ‰çŠ¶æ€çš„æ™ºèƒ½ä½“
- åœ¨æ•°æ®åº“ï¼ˆSQLiteï¼‰ä¸­æŒä¹…åŒ–ä¼šè¯
- ä¸Šä¸‹æ–‡å‹ç¼©ä»¥ç®¡ç†å¯¹è¯å†å²
- ä¼šè¯çŠ¶æ€ç®¡ç†ä»¥åœ¨å¯¹è¯ä¸­å…±äº«æ•°æ®

**æ ¸å¿ƒæ¦‚å¿µï¼š**
- **ä¼šè¯**ï¼šå•ä¸ªè¿ç»­å¯¹è¯çš„å®¹å™¨
- **äº‹ä»¶**ï¼šå¯¹è¯çš„æ„å»ºå—ï¼ˆç”¨æˆ·è¾“å…¥ã€æ™ºèƒ½ä½“å“åº”ã€å·¥å…·è°ƒç”¨ï¼‰
- **ä¼šè¯çŠ¶æ€**ï¼šå¯¹è¯æœŸé—´åŠ¨æ€è¯¦æƒ…çš„é”®å€¼å­˜å‚¨
- **æŒä¹…åŒ–**ï¼šä½¿ç”¨ DatabaseSessionService åœ¨é‡å¯åä¿ç•™
- **ä¸Šä¸‹æ–‡å‹ç¼©**ï¼šè‡ªåŠ¨æ€»ç»“å¯¹è¯å†å²

**ç¤ºä¾‹ç”¨ä¾‹ï¼š**
- è®°ä½å¯¹è¯ä¸Šä¸‹æ–‡çš„èŠå¤©æœºå™¨äºº
- éœ€è¦çŠ¶æ€çš„å¤šè½®äº¤äº’
- é€šè¿‡è‡ªåŠ¨æ€»ç»“å‡å°‘ä»¤ç‰Œæˆæœ¬
- åœ¨ä¼šè¯å†…å…±äº«ç”¨æˆ·åå¥½

### 2. `day_3b_agent_memory.py`
**å†…å­˜ç®¡ç† ç¬¬2éƒ¨åˆ† - é•¿æœŸå†…å­˜**

æ­¤è„šæœ¬æ¼”ç¤ºï¼š
- åˆå§‹åŒ– MemoryService ä»¥è¿›è¡Œé•¿æœŸçŸ¥è¯†å­˜å‚¨
- å°†ä¼šè¯æ•°æ®ä¼ è¾“åˆ°æŒä¹…åŒ–å†…å­˜
- è·¨ä¼šè¯æœç´¢å’Œæ£€ç´¢è®°å¿†
- ä½¿ç”¨å›è°ƒè‡ªåŠ¨åŒ–å†…å­˜å­˜å‚¨
- ç†è§£è®°å¿†æ•´åˆæ¦‚å¿µ

**æ ¸å¿ƒæ¦‚å¿µï¼š**
- **å†…å­˜ä¸ä¼šè¯**ï¼šä¼šè¯ = çŸ­æœŸï¼ˆå•ä¸ªå¯¹è¯ï¼‰ï¼Œå†…å­˜ = é•¿æœŸï¼ˆè·¨å¯¹è¯ï¼‰
- **å†…å­˜æ£€ç´¢**ï¼šload_memoryï¼ˆå“åº”å¼ï¼‰vs preload_memoryï¼ˆä¸»åŠ¨å¼ï¼‰
- **è·¨å¯¹è¯å›å¿†**ï¼šè®¿é—®ä»»ä½•è¿‡å»å¯¹è¯ä¸­çš„ä¿¡æ¯
- **å›è°ƒ**ï¼šåœ¨æ¯ä¸ªæ™ºèƒ½ä½“è½®æ¬¡åè‡ªåŠ¨ä¿å­˜å†…å­˜
- **è®°å¿†æ•´åˆ**ï¼šä»å†—é•¿çš„å¯¹è¯ä¸­æå–å…³é”®äº‹å®

**ç¤ºä¾‹ç”¨ä¾‹ï¼š**
- é•¿æœŸè®°ä½ç”¨æˆ·åå¥½çš„ä¸ªäººåŠ©æ‰‹
- å›å¿†è¿‡å»äº’åŠ¨çš„å®¢æˆ·æ”¯æŒæ™ºèƒ½ä½“
- è·¨å¤šä¸ªå¯¹è¯çš„çŸ¥è¯†ç§¯ç´¯
- åŸºäºå†å²æ•°æ®çš„ä¸ªæ€§åŒ–ä½“éªŒ

## å…ˆå†³æ¡ä»¶

ç¡®ä¿æ‚¨å·²å®Œæˆé¡¹ç›®æ ¹ç›®å½•çš„è®¾ç½®ï¼š

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•
source venv/bin/activate  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
```

å¦‚æœæ‚¨å°šæœªè®¾ç½®é¡¹ç›®ï¼Œè¯·è¿è¡Œï¼š

```bash
cd ..  # è½¬åˆ°é¡¹ç›®æ ¹ç›®å½•
./setup.sh
source venv/bin/activate
```

## è¿è¡Œè„šæœ¬

### è¿è¡Œè„šæœ¬ 3aï¼ˆä¼šè¯ï¼‰

```bash
# ç¡®ä¿æ‚¨åœ¨ Day-3 ç›®å½•ä¸­ä¸” venv å·²æ¿€æ´»
python day_3a_agent_sessions.py
```

**å®ƒåšä»€ä¹ˆï¼š**
1. **ç¬¬2èŠ‚**ï¼šä½¿ç”¨ InMemorySessionService åˆ›å»ºæœ‰çŠ¶æ€æ™ºèƒ½ä½“
   - æ¼”ç¤ºä¼šè¯å†…çš„å¯¹è¯è®°å¿†
   - æ˜¾ç¤ºå¦‚ä½•åœ¨è½®æ¬¡ä¹‹é—´ç»´æŠ¤ä¸Šä¸‹æ–‡

2. **ç¬¬3èŠ‚**ï¼šå‡çº§åˆ° DatabaseSessionServiceï¼ˆSQLiteï¼‰
   - å°†å¯¹è¯æŒä¹…åŒ–åˆ°ç£ç›˜
   - æ¼”ç¤ºé‡å¯åæ¢å¤ä¼šè¯
   - æ˜¾ç¤ºä¼šè¯éš”ç¦»ï¼ˆå•ç‹¬çš„ä¼šè¯ä¸å…±äº«æ•°æ®ï¼‰

3. **ç¬¬4èŠ‚**ï¼šå®ç°ä¸Šä¸‹æ–‡å‹ç¼©
   - è‡ªåŠ¨æ€»ç»“é•¿å¯¹è¯
   - å‡å°‘ä»¤ç‰Œæˆæœ¬å¹¶æé«˜æ€§èƒ½
   - æ¼”ç¤ºåœ¨å†å²ä¸­æŸ¥æ‰¾å‹ç¼©äº‹ä»¶

4. **ç¬¬5èŠ‚**ï¼šä½¿ç”¨ä¼šè¯çŠ¶æ€
   - è‡ªå®šä¹‰å·¥å…·ä»¥ä¿å­˜/æ£€ç´¢ç”¨æˆ·ä¿¡æ¯
   - æ¼”ç¤ºä¼šè¯å†…çš„çŠ¶æ€æŒä¹…åŒ–
   - æ˜¾ç¤ºè·¨ä¼šè¯çŠ¶æ€å…±äº«

### è¿è¡Œè„šæœ¬ 3bï¼ˆå†…å­˜ï¼‰

```bash
python day_3b_agent_memory.py
```

**å®ƒåšä»€ä¹ˆï¼š**
1. **ç¬¬3èŠ‚**ï¼šåˆå§‹åŒ– MemoryService
   - è®¾ç½® SessionService å’Œ MemoryService
   - åˆ›å»ºå…·æœ‰å†…å­˜æ”¯æŒçš„æ™ºèƒ½ä½“

2. **ç¬¬4èŠ‚**ï¼šå°†ä¼šè¯æ•°æ®æ‘„å…¥åˆ°å†…å­˜ä¸­
   - è¿›è¡Œå¯¹è¯å¹¶å°†å…¶ä¿å­˜åˆ°å†…å­˜
   - æ¼”ç¤ºæ‰‹åŠ¨ `add_session_to_memory()` è°ƒç”¨
   - éªŒè¯ä¼šè¯æ•°æ®å·²ä¼ è¾“

3. **ç¬¬5èŠ‚**ï¼šå¯ç”¨å†…å­˜æ£€ç´¢
   - æ·»åŠ  `load_memory` å·¥å…·ä»¥è¿›è¡Œå“åº”å¼æ£€ç´¢
   - æµ‹è¯•è·¨ä¼šè¯å†…å­˜å›å¿†
   - æ¼”ç¤ºä»ä»£ç è¿›è¡Œæ‰‹åŠ¨å†…å­˜æœç´¢

4. **ç¬¬6èŠ‚**ï¼šè‡ªåŠ¨åŒ–å†…å­˜å­˜å‚¨
   - ä½¿ç”¨å›è°ƒè¿›è¡Œè‡ªåŠ¨å†…å­˜ä¿å­˜
   - å®ç° `preload_memory` ä»¥è¿›è¡Œä¸»åŠ¨æ£€ç´¢
   - æ˜¾ç¤ºé›¶æ‰‹åŠ¨å¹²é¢„çš„å†…å­˜ç®¡ç†

## ç†è§£è¾“å‡º

### ç¬¬3å¤©a è¾“å‡º

**ä¼šè¯åˆ›å»ºå’Œç®¡ç†ï¼š**
```
âœ… æœ‰çŠ¶æ€æ™ºèƒ½ä½“å·²åˆå§‹åŒ–ï¼
   - åº”ç”¨ç¨‹åºï¼šdefault
   - ç”¨æˆ·ï¼šdefault
   - ä½¿ç”¨ï¼šInMemorySessionService

### ä¼šè¯ï¼šstateful-agentic-session
ç”¨æˆ· > å—¨ï¼Œæˆ‘æ˜¯ Samï¼ç¾å›½çš„é¦–éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ
gemini-2.5-flash-lite > å—¨ Samï¼é¦–éƒ½æ˜¯åç››é¡¿ç‰¹åŒºã€‚

ç”¨æˆ· > ä½ å¥½ï¼æˆ‘çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿ
gemini-2.5-flash-lite > ä½ çš„åå­—æ˜¯ Samã€‚
```

**æ•°æ®åº“æŒä¹…åŒ–ï¼š**
- åˆ›å»º `my_agent_data.db` SQLite æ–‡ä»¶
- å­˜å‚¨æ‰€æœ‰å¸¦æœ‰æ—¶é—´æˆ³çš„ä¼šè¯äº‹ä»¶
- å¯ç”¨é‡å¯åæ¢å¤ä¼šè¯

**ä¸Šä¸‹æ–‡å‹ç¼©ï¼š**
- åœ¨é…ç½®çš„è½®æ¬¡æ•°åè§¦å‘ï¼ˆä¾‹å¦‚ï¼Œæ¯3è½®ï¼‰
- ç”¨ç®€æ´çš„æ‘˜è¦æ›¿æ¢å†—é•¿çš„å†å²
- åœ¨ä¼šè¯å†å²ä¸­æ˜¾ç¤ºå‹ç¼©äº‹ä»¶

**ä¼šè¯çŠ¶æ€ï¼š**
```
ä¼šè¯çŠ¶æ€å†…å®¹ï¼š
{'user:name': 'Sam', 'user:country': 'Poland'}

ğŸ” æ³¨æ„ 'user:name' å’Œ 'user:country' é”®æ­£åœ¨å­˜å‚¨æˆ‘ä»¬çš„æ•°æ®ï¼
```

### ç¬¬3å¤©b è¾“å‡º

**å†…å­˜åˆå§‹åŒ–ï¼š**
```
âœ… å·²åˆ›å»ºå…·æœ‰å†…å­˜æ”¯æŒçš„æ™ºèƒ½ä½“å’Œ Runnerï¼
```

**ä¼šè¯æ‘„å…¥ï¼š**
```
ğŸ“ ä¼šè¯åŒ…å«ï¼š
  user: æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“ç»¿è‰²...
  model: å®é™çš„èåˆï¼Œæµ·æ´‹çš„å¹³é™...

âœ… ä¼šè¯å·²æ·»åŠ åˆ°å†…å­˜ï¼
```

**è·¨ä¼šè¯æ£€ç´¢ï¼š**
```
### ä¼šè¯ï¼šbirthday-session-02
ç”¨æˆ· > æˆ‘çš„ç”Ÿæ—¥æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ
æ¨¡å‹ï¼š> ä½ çš„ç”Ÿæ—¥æ˜¯3æœˆ15æ—¥ã€‚
```
ï¼ˆæ³¨æ„ï¼šä¸åŒçš„ä¼šè¯ IDï¼Œä½†æ™ºèƒ½ä½“ä»ç„¶è®°å¾—ï¼ï¼‰

**è‡ªåŠ¨å†…å­˜ï¼š**
```
âœ… å·²åˆ›å»ºå…·æœ‰è‡ªåŠ¨å†…å­˜ä¿å­˜çš„æ™ºèƒ½ä½“ï¼

# ç¬¬ä¸€æ¬¡å¯¹è¯
ç”¨æˆ· > æˆ‘é€äº†ä¾„å­ä¸€ä¸ªæ–°ç©å…·...

# ç¬¬äºŒæ¬¡å¯¹è¯ï¼ˆæ–°ä¼šè¯ï¼‰
ç”¨æˆ· > æˆ‘é€äº†ä¾„å­ä»€ä¹ˆç¤¼ç‰©ï¼Ÿ
æ¨¡å‹ï¼š> ä½ åœ¨ä¾„å­1å²ç”Ÿæ—¥æ—¶é€äº†ä»–ä¸€ä¸ªæ–°ç©å…·ã€‚
```

## å…³é”®æ¨¡å¼å’Œä½¿ç”¨æ—¶æœº

### ä¼šè¯ç±»å‹

| æœåŠ¡ | æŒä¹…åŒ– | ç”¨ä¾‹ |
|---------|-------------|----------|
| **InMemorySessionService** | âŒ é‡å¯æ—¶ä¸¢å¤± | å¿«é€ŸåŸå‹ã€æµ‹è¯• |
| **DatabaseSessionService** | âœ… é‡å¯åä¿ç•™ | ä¸­å°å‹åº”ç”¨ã€æœ¬åœ°å¼€å‘ |
| **Agent Engine Sessions** | âœ… å®Œå…¨æ‰˜ç®¡ï¼ˆGCPï¼‰ | ä¼ä¸šè§„æ¨¡ã€ç”Ÿäº§ç¯å¢ƒ |

### å†…å­˜æ£€ç´¢ç­–ç•¥

**load_memoryï¼ˆå“åº”å¼ï¼‰**
```python
agent = LlmAgent(
    tools=[load_memory],  # æ™ºèƒ½ä½“å†³å®šä½•æ—¶æœç´¢
)
```
**ä½•æ—¶ä½¿ç”¨ï¼š**
- æƒ³è¦èŠ‚çœä»¤ç‰Œï¼ˆä»…åœ¨éœ€è¦æ—¶æœç´¢ï¼‰
- æ™ºèƒ½ä½“å¯ä»¥æ¨ç†å†…å­˜ä½•æ—¶ç›¸å…³
- å¤§å¤šæ•°æŸ¥è¯¢ä¸éœ€è¦å†å²ä¸Šä¸‹æ–‡

**preload_memoryï¼ˆä¸»åŠ¨å¼ï¼‰**
```python
agent = LlmAgent(
    tools=[preload_memory],  # åœ¨æ¯ä¸ªè½®æ¬¡ä¹‹å‰å§‹ç»ˆåŠ è½½
)
```
**ä½•æ—¶ä½¿ç”¨ï¼š**
- å†…å­˜å§‹ç»ˆç›¸å…³ï¼ˆä¾‹å¦‚ï¼Œä¸ªäººåŠ©æ‰‹ï¼‰
- æƒ³è¦ä¿è¯ä¸Šä¸‹æ–‡å¯ç”¨æ€§
- æ„¿æ„ä¸ºäº†å¯é æ€§è€Œç‰ºç‰²æ•ˆç‡

### ä¸Šä¸‹æ–‡å‹ç¼©

**ä½•æ—¶ä½¿ç”¨ï¼š**
```python
app = App(
    name="my_app",
    root_agent=agent,
    events_compaction_config=EventsCompactionConfig(
        compaction_interval=3,  # æ¯3è½®å‹ç¼©ä¸€æ¬¡
        overlap_size=1,         # ä¿ç•™1ä¸ªä¸Šä¸€è½®æ¬¡ä»¥ä¿æŒä¸Šä¸‹æ–‡
    ),
)
```

**å¥½å¤„ï¼š**
- å‡å°‘ä»¤ç‰Œæˆæœ¬ï¼ˆå¯èƒ½å‡å°‘20-80%ï¼‰
- æé«˜æ€§èƒ½ï¼ˆå¤„ç†çš„ä¸Šä¸‹æ–‡æ›´å°‘ï¼‰
- ç»´æŠ¤å¯¹è¯è¿ç»­æ€§
- ä¸“æ³¨äºé‡è¦ä¿¡æ¯

**æœ€é€‚åˆï¼š**
- é•¿å¯¹è¯ï¼ˆ10+è½®ï¼‰
- é‡å¤æ€§äº¤äº’
- ä¿¡æ¯å¯†é›†çš„å¯¹è¯

### è‡ªåŠ¨å†…å­˜å­˜å‚¨

**ä½¿ç”¨å›è°ƒï¼š**
```python
async def auto_save_to_memory(callback_context):
    await callback_context._invocation_context.memory_service.add_session_to_memory(
        callback_context._invocation_context.session
    )

agent = LlmAgent(
    after_agent_callback=auto_save_to_memory,  # åœ¨æ¯ä¸ªè½®æ¬¡åä¿å­˜
    tools=[preload_memory],
)
```

**ä½•æ—¶ä½¿ç”¨ï¼š**
- æ¯ä¸ªå¯¹è¯éƒ½åº”è¯¥è¢«è®°ä½
- æƒ³è¦é›¶æ‰‹åŠ¨å¹²é¢„çš„å†…å­˜
- æ„å»ºç”Ÿäº§ä¸ªäººåŠ©æ‰‹
- å®¢æˆ·æ”¯æŒç³»ç»Ÿ

## ä¼šè¯çŠ¶æ€ vs å†…å­˜

| ç‰¹æ€§ | ä¼šè¯çŠ¶æ€ | å†…å­˜ |
|---------|---------------|--------|
| **èŒƒå›´** | å•ä¸ªä¼šè¯ | æ‰€æœ‰ä¼šè¯ |
| **å­˜å‚¨** | é”®å€¼å¯¹ | ç»“æ„åŒ–è®°å¿† |
| **è®¿é—®** | `tool_context.state` | `load_memory` / `preload_memory` |
| **æŒä¹…åŒ–** | å–å†³äº SessionService | å§‹ç»ˆæŒä¹…åŒ– |
| **æœ€é€‚åˆ** | ä¸´æ—¶å·¥ä½œæµæ•°æ® | é•¿æœŸäº‹å®å’Œåå¥½ |

**ç¤ºä¾‹ï¼š**
```python
# ä¼šè¯çŠ¶æ€ - ä¸´æ—¶ï¼Œå•ä¸ªå¯¹è¯
tool_context.state["user:current_order_id"] = "12345"

# å†…å­˜ - é•¿æœŸï¼Œè·¨å¯¹è¯
await memory_service.add_session_to_memory(session)  # å­˜å‚¨äº‹å®
```

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ï¼šä¼šè¯åœ¨é‡å¯åä¸æŒä¹…
**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨ `DatabaseSessionService` è€Œä¸æ˜¯ `InMemorySessionService`
- æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶è·¯å¾„æ˜¯å¦å¯è®¿é—®
- éªŒè¯æ•°æ®åº“æ–‡ä»¶åœ¨è¿è¡Œä¹‹é—´æœªè¢«åˆ é™¤

```python
# ä»£æ›¿ï¼š
session_service = InMemorySessionService()

# ä½¿ç”¨ï¼š
session_service = DatabaseSessionService(db_url="sqlite:///my_data.db")
```

### é—®é¢˜ï¼šæ™ºèƒ½ä½“åœ¨ä¼šè¯ä¹‹é—´ä¸è®°å¾—
**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿æ‚¨æ­£åœ¨è°ƒç”¨ `add_session_to_memory()`
- éªŒè¯ `memory_service` å·²ä¼ é€’ç»™ Runner
- å°† `load_memory` æˆ– `preload_memory` æ·»åŠ åˆ°æ™ºèƒ½ä½“å·¥å…·

```python
# å¿…é¡»åŒæ—¶å…·å¤‡ï¼š
runner = Runner(
    agent=agent,
    session_service=session_service,
    memory_service=memory_service,  # å¿…éœ€ï¼
)

# ä»¥åŠï¼š
agent = LlmAgent(
    tools=[load_memory],  # æˆ– preload_memory
)
```

### é—®é¢˜ï¼šä¸Šä¸‹æ–‡å‹ç¼©æœªå‘ç”Ÿ
**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨å¸¦æœ‰ `events_compaction_config` çš„ `App`ï¼Œè€Œä¸ä»…ä»…æ˜¯åŸå§‹ Agent
- å°† `app=` ä¼ é€’ç»™ Runnerï¼ˆè€Œä¸æ˜¯ `agent=`ï¼‰
- æ£€æŸ¥ `compaction_interval` æ˜¯å¦åŒ¹é…æ‚¨çš„è½®æ¬¡æ•°

```python
# å¿…é¡»ä½¿ç”¨ Appï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ Agentï¼š
app = App(
    root_agent=agent,
    events_compaction_config=EventsCompactionConfig(
        compaction_interval=3,
    ),
)

runner = Runner(app=app, ...)  # ä½¿ç”¨ app=ï¼Œè€Œä¸æ˜¯ agent=
```

### é—®é¢˜ï¼šä¼šè¯çŠ¶æ€æœªè·¨ä¼šè¯å…±äº«
**è§£å†³æ–¹æ¡ˆï¼š**
- è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼ä¼šè¯çŠ¶æ€æ˜¯ä¼šè¯èŒƒå›´çš„
- å¯¹äºè·¨ä¼šè¯å…±äº«ï¼Œè¯·æ”¹ç”¨å†…å­˜
- æˆ–è€…ä½¿ç”¨ç”¨æˆ·èŒƒå›´çš„å‰ç¼€ï¼šçŠ¶æ€é”®ä¸­çš„ `user:`

```python
# ä¼šè¯èŒƒå›´ï¼ˆéš”ç¦»ï¼‰ï¼š
tool_context.state["temp:order"] = "12345"

# ç”¨æˆ·èŒƒå›´ï¼ˆè·¨ä¼šè¯å…±äº«ï¼‰ï¼š
tool_context.state["user:preference"] = "dark_mode"
```

### é—®é¢˜ï¼šå†…å­˜æ£€ç´¢è¿”å›å¤ªå¤š/å¤ªå°‘çš„ç»“æœ
**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨ InMemoryMemoryServiceï¼šä½¿ç”¨ç²¾ç¡®å…³é”®è¯
- ç»†åŒ–æœç´¢æŸ¥è¯¢ä½¿å…¶æ›´å…·ä½“
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ VertexAiMemoryBankService è¿›è¡Œè¯­ä¹‰æœç´¢

```python
# æ•ˆæœè¾ƒå·®ï¼ˆæ¨¡ç³Šï¼‰ï¼š
search_memory(query="ä»€ä¹ˆé¢œè‰²")

# æ•ˆæœæ›´å¥½ï¼ˆå…·ä½“ï¼‰ï¼š
search_memory(query="ç”¨æˆ·æœ€å–œæ¬¢çš„é¢œè‰²åå¥½")
```

## è®°å¿†æ•´åˆï¼ˆé«˜çº§ï¼‰

**ä»€ä¹ˆæ˜¯æ•´åˆï¼Ÿ**

ä¸å…¶å­˜å‚¨åŸå§‹å¯¹è¯äº‹ä»¶ï¼Œæ•´åˆæå–å…³é”®äº‹å®ï¼š

**æ•´åˆå‰ï¼ˆåŸå§‹å­˜å‚¨ï¼‰ï¼š**
```
ç”¨æˆ·ï¼š"æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“ç»¿è‰²ã€‚æˆ‘ä¹Ÿå–œæ¬¢ç´«è‰²ã€‚
       å®é™…ä¸Šï¼Œæˆ‘å¤§å¤šæ•°æ—¶å€™æ›´å–œæ¬¢è“ç»¿è‰²ã€‚"
æ™ºèƒ½ä½“ï¼š"å¤ªå¥½äº†ï¼æˆ‘ä¼šè®°ä½çš„ã€‚"
ç”¨æˆ·ï¼š"è°¢è°¢ï¼"
æ™ºèƒ½ä½“ï¼š"ä¸å®¢æ°”ï¼"

â†’ å­˜å‚¨æ‰€æœ‰4æ¡æ¶ˆæ¯ï¼ˆå†—ä½™ã€å†—é•¿ï¼‰
```

**æ•´åˆåï¼š**
```
æå–çš„è®°å¿†ï¼š"ç”¨æˆ·æœ€å–œæ¬¢çš„é¢œè‰²ï¼šè“ç»¿è‰²"

â†’ å­˜å‚¨1ä¸ªç®€æ´çš„äº‹å®
```

**æ³¨æ„ï¼š** `InMemoryMemoryService` ä¸è¿›è¡Œæ•´åˆã€‚å¯¹äºç”Ÿäº§æ•´åˆï¼Œè¯·ä½¿ç”¨ **Vertex AI Memory Bank**ï¼ˆåœ¨ç¬¬5å¤©ä¸­ä»‹ç»ï¼‰ã€‚

## å­¦ä¹ èµ„æº

### ADK æ–‡æ¡£
- [ADK ä¼šè¯](https://google.github.io/adk-docs/sessions/)
- [ADK å†…å­˜](https://google.github.io/adk-docs/sessions/memory/)
- [ä¸Šä¸‹æ–‡å‹ç¼©](https://google.github.io/adk-docs/context/compaction/)
- [ä¸Šä¸‹æ–‡ç¼“å­˜](https://google.github.io/adk-docs/context/caching/)
- [ADK å›è°ƒ](https://google.github.io/adk-docs/agents/callbacks/)

### Google Cloud æ–‡æ¡£
- [Vertex AI Memory Bank æ¦‚è¿°](https://cloud.google.com/vertex-ai/generative-ai/docs/agent-engine/memory-bank/overview)
- [è®°å¿†æ•´åˆæŒ‡å—](https://cloud.google.com/vertex-ai/generative-ai/docs/agent-engine/memory-bank/generate-memories)

### Medium æ–‡ç« 
- [ä½¿ç”¨å·¥ä»¶é«˜æ•ˆç®¡ç†ä¸Šä¸‹æ–‡](https://medium.com/google-cloud/2-minute-adk-manage-context-efficiently-with-artifacts-6fcc6683d274)

## æœ€ä½³å®è·µ

### ä¼šè¯ç®¡ç†

1. **é€‰æ‹©æ­£ç¡®çš„ SessionService**
   - å¼€å‘ï¼š`InMemorySessionService`
   - ç”Ÿäº§ï¼š`DatabaseSessionService` æˆ–æ‰˜ç®¡äº‘æœåŠ¡

2. **ä¼šè¯ ID å‘½å**
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„ IDï¼š`user_123_chat_2025_01_15`
   - ä¸ºå¤šç”¨æˆ·åº”ç”¨åŒ…å«ç”¨æˆ·æ ‡è¯†ç¬¦
   - è€ƒè™‘åŒ…å«æ—¶é—´æˆ³ä»¥è¿›è¡Œæ—¶é—´ç»„ç»‡

3. **ä¼šè¯ç”Ÿå‘½å‘¨æœŸ**
   - å¼€å§‹å¯¹è¯æ—¶æ˜¾å¼åˆ›å»ºä¼šè¯
   - å®šæœŸæ¸…ç†æ—§ä¼šè¯ï¼ˆå¯¹äº DatabaseSessionServiceï¼‰
   - æ ¹æ®éšç§è¦æ±‚è®¾ç½®ä¿ç•™ç­–ç•¥

### å†…å­˜ç®¡ç†

1. **ä½•æ—¶ä¿å­˜åˆ°å†…å­˜**
   - åœ¨å¯¹è¯ä¸­çš„é‡è¦é‡Œç¨‹ç¢‘ä¹‹å
   - å½“ç”¨æˆ·æ˜ç¡®æä¾›åå¥½/äº‹å®æ—¶
   - åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨å›è°ƒè¿›è¡Œè‡ªåŠ¨ä¿å­˜

2. **å†…å­˜æœç´¢æœ€ä½³å®è·µ**
   - åœ¨æœç´¢æŸ¥è¯¢ä¸­è¦å…·ä½“
   - å¯¹é«˜å¬å›åœºæ™¯ä½¿ç”¨ `preload_memory`
   - å½“å†…å­˜å¹¶éå§‹ç»ˆéœ€è¦æ—¶ä½¿ç”¨ `load_memory` ä»¥èŠ‚çœæˆæœ¬

3. **å†…å­˜å«ç”Ÿ**
   - å®šæœŸå®¡æŸ¥å­˜å‚¨çš„è®°å¿†ä»¥ç¡®ä¿å‡†ç¡®æ€§
   - ä¸ºç”¨æˆ·éšç§å®æ–½è®°å¿†åˆ é™¤ï¼ˆGDPR åˆè§„ï¼‰
   - è€ƒè™‘è®°å¿†è¿‡æœŸç­–ç•¥

### ä¸Šä¸‹æ–‡å·¥ç¨‹

1. **å‹ç¼©é…ç½®**
   - ä» `compaction_interval=5` å¼€å§‹å¹¶æ ¹æ®ç”¨ä¾‹è°ƒæ•´
   - ä¿æŒ `overlap_size=1-2` ä»¥ç»´æŠ¤å¯¹è¯æµç¨‹
   - ç›‘æ§ä»¤ç‰ŒèŠ‚çœä¸ä¸Šä¸‹æ–‡è´¨é‡

2. **çŠ¶æ€ç®¡ç†**
   - ä½¿ç”¨ä¸€è‡´çš„å‰ç¼€ï¼š`user:`ã€`temp:`ã€`app:`
   - ä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºè®°å½•çŠ¶æ€æ¶æ„
   - åœ¨å·¥ä½œæµç¨‹å®Œæˆæ—¶æ¸…ç†ä¸´æ—¶çŠ¶æ€

3. **é”™è¯¯å¤„ç†**
   ```python
   try:
       session = await session_service.get_session(...)
   except Exception as e:
       # å¦‚æœæœªæ‰¾åˆ°åˆ™åˆ›å»ºæ–°ä¼šè¯
       session = await session_service.create_session(...)
   ```

## æ¶æ„æ¨¡å¼

### æ¨¡å¼ 1ï¼šæ— çŠ¶æ€æ™ºèƒ½ä½“ï¼ˆç®€å•ï¼‰
```python
# æ— ä¼šè¯ï¼Œæ— å†…å­˜ - æ¯ä¸ªè°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹çš„
agent = LlmAgent(...)
result = agent.run(query="å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")
```
**ç”¨äºï¼š** ä¸€æ¬¡æ€§æŸ¥è¯¢ã€æ— çŠ¶æ€ API

### æ¨¡å¼ 2ï¼šä»…ä¼šè¯æ™ºèƒ½ä½“ï¼ˆä¸­ç­‰ï¼‰
```python
# ç”¨äºå¯¹è¯ä¸Šä¸‹æ–‡çš„ä¼šè¯ï¼Œæ— é•¿æœŸå†…å­˜
runner = Runner(
    agent=agent,
    session_service=InMemorySessionService(),
)
```
**ç”¨äºï¼š** å•å¯¹è¯èŠå¤©æœºå™¨äººã€ä¸´æ—¶æ”¯æŒ

### æ¨¡å¼ 3ï¼šå®Œæ•´å†…å­˜æ™ºèƒ½ä½“ï¼ˆé«˜çº§ï¼‰
```python
# ä¼šè¯ + å†…å­˜ + å‹ç¼©
app = App(
    root_agent=LlmAgent(
        tools=[preload_memory],
        after_agent_callback=auto_save_to_memory,
    ),
    events_compaction_config=EventsCompactionConfig(...),
)

runner = Runner(
    app=app,
    session_service=DatabaseSessionService(...),
    memory_service=memory_service,
)
```
**ç”¨äºï¼š** ä¸ªäººåŠ©æ‰‹ã€é•¿æœŸå®¢æˆ·å…³ç³»

## æ•°æ®åº“ç®¡ç†

### SQLite æç¤ºï¼ˆDatabaseSessionServiceï¼‰

**æ•°æ®åº“æ–‡ä»¶ä½ç½®ï¼š**
```python
# ç›¸å¯¹è·¯å¾„ï¼ˆåœ¨å½“å‰ç›®å½•ä¸­ï¼‰
db_url = "sqlite:///sessions.db"

# ç»å¯¹è·¯å¾„
db_url = "sqlite:////absolute/path/to/sessions.db"
```

**æ£€æŸ¥æ•°æ®åº“ï¼š**
```python
import sqlite3

with sqlite3.connect("my_agent_data.db") as conn:
    cursor = conn.cursor()

    # æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
    cursor.execute("SELECT DISTINCT session_id FROM events")
    print(cursor.fetchall())

    # æŸ¥çœ‹ä¼šè¯çš„äº‹ä»¶
    cursor.execute("""
        SELECT author, content
        FROM events
        WHERE session_id = 'my-session-01'
    """)
    for row in cursor.fetchall():
        print(row)
```

**æ¸…ç†æ—§ä¼šè¯ï¼š**
```python
# åˆ é™¤30å¤©å‰çš„ä¼šè¯
cursor.execute("""
    DELETE FROM events
    WHERE timestamp < datetime('now', '-30 days')
""")
conn.commit()
```

## ä¸‹ä¸€æ­¥

å®Œæˆç¬¬3å¤©åï¼Œæ‚¨å·²ç»å­¦ä¹ äº†ï¼š
- âœ… æœ‰çŠ¶æ€å¯¹è¯çš„ä¼šè¯ç®¡ç†
- âœ… ä½¿ç”¨æ•°æ®åº“çš„æŒä¹…åŒ–å­˜å‚¨
- âœ… ä½¿ç”¨å‹ç¼©çš„ä¸Šä¸‹æ–‡å·¥ç¨‹
- âœ… è·¨ä¼šè¯çš„é•¿æœŸå†…å­˜
- âœ… ä½¿ç”¨å›è°ƒçš„è‡ªåŠ¨å†…å­˜ç®¡ç†

**ç»§ç»­åˆ°ç¬¬4å¤©**ä»¥å­¦ä¹ ï¼š
- å¯è§‚å¯Ÿæ€§å’Œç›‘æ§
- æ™ºèƒ½ä½“è¯„ä¼°å’Œæµ‹è¯•
- æ€§èƒ½æŒ‡æ ‡
- ç”Ÿäº§å°±ç»ª

**ç»ƒä¹ ï¼š**
1. æ„å»ºä¸€ä¸ªè®°ä½ç”¨æˆ·åå¥½çš„ä¸ªäººåŠ©æ‰‹
2. åˆ›å»ºä¸€ä¸ªå…·æœ‰ä¼šè¯å†å²çš„å®¢æˆ·æ”¯æŒæ™ºèƒ½ä½“
3. å®ç°ä¸€ä¸ªå…·æœ‰çŸ¥è¯†ç§¯ç´¯çš„ç ”ç©¶æ™ºèƒ½ä½“
4. ä¸ºæ‚¨çš„ç¬¬2å¤©æ™ºèƒ½ä½“æ·»åŠ å†…å­˜ä»¥å¢å¼ºä¸Šä¸‹æ–‡

ç¥å­¦ä¹ æ„‰å¿«ï¼ğŸ§ ğŸ’¾
